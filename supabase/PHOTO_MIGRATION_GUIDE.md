# üì∏ Photo Migration Guide: Piscola2 ‚Üí piscola-prod

This guide will help you migrate all venue photos from your development Supabase project (Piscola2) to your production project (piscola-prod), ensuring a clean, production-ready setup.

## üéØ What This Migration Does

1. **Creates** the `venue-photos` bucket in production with proper RLS policies
2. **Downloads** all photos from your development project
3. **Uploads** them to production with identical folder structure
4. **Updates** all database URLs to point to production storage
5. **Preserves** all existing photo organization and paths

## üìã Prerequisites

- [x] You have access to both Supabase projects
- [x] Node.js installed on your machine
- [x] Supabase credentials for both projects

## üöÄ Migration Steps

### Step 1: Create Production Storage Bucket

1. **Open Supabase Dashboard**: https://supabase.com/dashboard/project/udpygouyogrwvwjbzdul/sql/new
2. **Copy** the contents of `MIGRATE_PHOTOS_STEP1_CREATE_BUCKET.sql`
3. **Paste** into the SQL Editor
4. **Click "RUN"** to execute
5. **Verify** success - you should see "‚úÖ SETUP COMPLETE"

### Step 2: Analyze Current Photos

1. **Same Supabase Dashboard** (keep it open)
2. **Copy** the contents of `MIGRATE_PHOTOS_STEP2_GET_URLS.sql`
3. **Paste** and **Run**
4. **Review** the output to understand what will be migrated
   - How many venues have photos
   - How many photos need migration
   - Sample file paths

### Step 3: Migrate Photos (Node.js Script)

#### Setup Configuration

1. **Copy the config template**:

   ```bash
   cp scripts/migration-config.example.js scripts/migration-config.js
   ```

2. **Get your Supabase credentials**:

   **For Piscola2 (Development)**:
   - Go to: https://supabase.com/dashboard/project/lnoaurqbnmxbsfaahnjw/settings/api
   - Copy: Project URL, anon key, service_role key

   **For piscola-prod (Production)**:
   - Go to: https://supabase.com/dashboard/project/udpygouyogrwvwjbzdul/settings/api
   - Copy: Project URL, anon key, service_role key

3. **Update `scripts/migration-config.js`** with your actual credentials

#### Run Migration

1. **Install dependencies** (if not already done):

   ```bash
   npm install
   ```

2. **Run the migration script**:

   ```bash
   node scripts/migrate-photos.js
   ```

3. **Monitor the output**:
   - The script will show progress for each photo
   - It will create a mapping file for URL updates
   - Wait for completion message

### Step 4: Update Database URLs

1. **Return to Supabase Dashboard**: https://supabase.com/dashboard/project/udpygouyogrwvwjbzdul/sql/new
2. **Copy** the contents of `MIGRATE_PHOTOS_STEP4_UPDATE_URLS.sql`
3. **Paste** and **Run** the preview section first
4. **Review** the dry run output
5. **Uncomment** the UPDATE section in the script
6. **Run again** to execute the actual URL updates

### Step 5: Verification & Testing

1. **Check the verification queries** in Step 4's output
2. **Test photo uploads**:
   - Go to your website: https://piscola.net/venues/new
   - Try uploading a photo
   - Should work without errors now!
3. **Verify existing photos**:
   - Browse venues that had photos before
   - Confirm they still display correctly

## üìä Migration Summary

After completion, you should have:

- ‚úÖ All photos migrated from dev to production
- ‚úÖ Database URLs updated to production
- ‚úÖ Photo uploads working on live site
- ‚úÖ All existing photos still displaying
- ‚úÖ Proper RLS policies in place

## üîß Troubleshooting

### "Configuration file not found"

**Solution**: Copy `migration-config.example.js` to `migration-config.js` and update credentials

### "Bucket not found in production"

**Solution**: Run Step 1 (CREATE_BUCKET.sql) first

### "Permission denied" during upload

**Solution**: Ensure you're using the **service_role** key for production (not just anon key)

### Photos still not uploading after migration

**Solution**:

1. Check browser console for specific errors
2. Verify bucket exists: https://supabase.com/dashboard/project/udpygouyogrwvwjbzdul/storage/buckets
3. Confirm RLS policies are active

### Some photos didn't migrate

**Solution**: Check the migration script output for specific error messages. Common causes:

- Network timeouts (re-run the script)
- Malformed URLs in database
- File access permissions

## üóÇÔ∏è File Structure

```
supabase/
‚îú‚îÄ‚îÄ MIGRATE_PHOTOS_STEP1_CREATE_BUCKET.sql    # Creates bucket + policies
‚îú‚îÄ‚îÄ MIGRATE_PHOTOS_STEP2_GET_URLS.sql         # Analyzes current photos
‚îú‚îÄ‚îÄ MIGRATE_PHOTOS_STEP4_UPDATE_URLS.sql      # Updates database URLs
‚îú‚îÄ‚îÄ PHOTO_MIGRATION_GUIDE.md                  # This guide
‚îî‚îÄ‚îÄ photo-url-mapping.json                    # Generated by script

scripts/
‚îú‚îÄ‚îÄ migrate-photos.js                         # Main migration script
‚îú‚îÄ‚îÄ migration-config.example.js               # Template for credentials
‚îî‚îÄ‚îÄ migration-config.js                       # Your actual credentials (create this)
```

## üîí Security Notes

- **Never commit** `migration-config.js` to git
- **Service role keys** have admin privileges - keep them secure
- **Delete** the config file after migration if desired
- The **production service role key** is required for uploads

## üéâ Success!

Once completed, your production environment will be fully self-contained with:

- All photos hosted in production
- Working photo uploads
- Proper security policies
- Clean separation from development

Your Piscola.net site should now work perfectly for photo uploads and display! ü•Ç
